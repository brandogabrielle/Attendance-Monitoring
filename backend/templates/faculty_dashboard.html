<!DOCTYPE html>
<html lang="en">
<head>
  <title>Faculty Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='facultydashboard.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
  <!-- Left Green Bar -->
  <div class="sidebar">
    <div class="sidebar-top">
      <a class="main-icon">
        <img src="{{ url_for('static', filename='udmlogo.jpeg') }}" alt="Main Logo" class="sidebar-image">
      </a>
      <a href="home.html" class="sidebar-icon"><i class="fas fa-home"></i></a>
      <a href="list.html" class="sidebar-icon"><i class="fas fa-list"></i></a>
      <a href="scanner.html" class="sidebar-icon"><i class="fas fa-qrcode"></i></a>
      <a href="#" class="sidebar-icon"><i class="fas fa-question"></i></a>
    </div>
    <div class="sidebar-bottom">
      <a href="settings.html" class="sidebar-icon"><i class="fas fa-cog"></i></a>
    </div>
  </div>

  <!-- Top White Bar -->
  <div class="top-bar"></div>
<!-- Main Content -->
<div class="main-content">

  <div class="content-wrapper">
    <!-- QR Scanner Box -->
    <div class="box">
      <h2>üì∑ Attendance Scanner</h2>
      <div id="reader" style="width: 350px;"></div>
      <p id="scan-result">Waiting for QR code...</p>
      <div id="message" style="font-weight: bold; margin-top: 1em;"></div>
    </div>

     <!-- Start Attendance -->
        <h2>üéØ Start Attendance Session</h2>
        <label for="subject">Subject:</label>
        <select id="subject">
          <option value="">--Select Subject--</option>
          <option value="Math 101">Math 101</option>
          <option value="Physics 201">Physics 201</option>
        </select>

        <label for="section">Section:</label>
        <select id="section">
          <option value="">--Select Section--</option>
          <option value="Section A">Section A</option>
          <option value="Section B">Section B</option>
        </select>

        <button id="start-session">Start Attendance</button>
        <p id="session-status" style="color: green; font-weight: bold;"></p>
      </div>

    <!-- Recent Scans Box -->
<div class="box">
  <h3>Attendance Logs</h3>
  <table id="recent-scans">
    <tr>
      <th>Time</th>
      <th>Student ID</th>
      <th>Name</th>
      <th>Status</th>
    </tr>
    <!-- Rows will be added here dynamically from database -->
  </table>
</div>

  </div>

</div>

  <script>
    let currentSubject = "";
    let currentSection = "";

    document.getElementById("start-session").addEventListener("click", () => {
      const subject = document.getElementById("subject").value;
      const section = document.getElementById("section").value;

      if (!subject || !section) {
        alert("Please select both subject and section before starting attendance.");
        return;
      }

      currentSubject = subject;
      currentSection = section;

      fetch('/faculty/start_session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subject, section })
      })
      .then(res => res.json())
      .then(result => {
        document.getElementById("session-status").innerText = result.message || "Session started!";
      })
      .catch(err => console.error(err));
    });

    function updateRecentScans(scans) {
      const table = document.getElementById('recent-scans');
      table.innerHTML = "<tr><th>Time</th><th>Student ID</th><th>Name</th><th>Status</th></tr>";
      scans.forEach(([time, id, name, status]) => {
        const row = document.createElement('tr');
        let color;
        if (status === "success") color = "green";
        else if (status === "error") color = "red";
        else if (status === "cooldown") color = "orange";
        row.innerHTML = `<td>${time}</td><td>${id}</td><td>${name}</td><td style="color:${color}">${status}</td>`;
        table.appendChild(row);
      });
    }

    let lastQrData = null;
    let lastScanTime = 0;
    const cooldown = 2000; // 2 seconds debounce

    function onScanSuccess(decodedText) {
        const now = Date.now();

        // 1Ô∏è‚É£ Ignore repeated scans within cooldown
        if (decodedText === lastQrData && now - lastScanTime < cooldown) {
          return;
        }

        lastQrData = decodedText;
        lastScanTime = now;

        try {
          const qrData = JSON.parse(decodedText);

          if (!currentSubject || !currentSection) {
            alert("Please start a session before scanning.");
            return;
          }

          const data = { ...qrData, subject: currentSubject, section: currentSection };

          fetch('/faculty/attend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          })
          .then(res => res.json())
          .then(result => {
            document.getElementById('message').innerText = result.message;
            updateRecentScans(result.recent_scans || []);
          });

        } catch (e) {
          alert("Invalid QR Code");
        }
      }

      // Initialize HTML5 QR Code Scanner with auto-pause
      let html5QrcodeScanner = new Html5QrcodeScanner(
        "reader",
        { fps: 10, qrbox: 250 },
        false
      );

      // Wrap onScanSuccess with pause/resume to prevent rapid firing
      html5QrcodeScanner.render((decodedText, result) => {
        onScanSuccess(decodedText);

        html5QrcodeScanner.pause(); // pause immediately after a scan
        setTimeout(() => html5QrcodeScanner.resume(), 1000); // resume after 1s
      });

  </script>
</body>
</html>