<!DOCTYPE html>
<html lang="en">
<head>
  <title>Faculty Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h1>📊 Faculty Dashboard</h1>
  <h3>Welcome, {{ faculty_name }}</h3>
  <p><strong>Faculty ID:</strong> {{ faculty_id }}</p>
  <p><strong>Section:</strong> {{ section }}</p>
  <p><strong>Subject:</strong> {{ subject }}</p>

  <hr>

  <!-- QR Scanner -->
  <h2>📷 Attendance Scanner</h2>
  <div id="reader" style="width: 300px;"></div>
  <p id="scan-result">Waiting for QR code...</p>
  <div id="message" style="font-weight: bold; margin-top: 1em;"></div>

  <hr>

  <a href="/records"><button>📄 View Attendance Records</button></a>

  <script>
    function onScanSuccess(decodedText) {
      document.getElementById('scan-result').innerText = "Scanned: " + decodedText;
      try {
        const data = JSON.parse(decodedText);

        // Add faculty info from template vars
        data.faculty_id = "{{ faculty_id }}";
        data.class_section = "{{ section }}";
        data.subject = "{{ subject }}";

        fetch('/faculty/attend', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(result => {
          const msgDiv = document.getElementById('message');
          if (result.status === 'success') {
            msgDiv.style.color = 'green';
          } else {
            msgDiv.style.color = 'red';
          }
          msgDiv.innerText = result.message;
        })
        .catch(err => {
          const msgDiv = document.getElementById('message');
          msgDiv.style.color = 'red';
          msgDiv.innerText = "⚠️ Error: " + err;
        });
      } catch (e) {
        alert("❌ Invalid QR Code format. Expected JSON.");
      }
    }

    let html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
    html5QrcodeScanner.render(onScanSuccess);
  </script>
</body>
</html>
